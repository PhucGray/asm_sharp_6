@page "/cart"
@using Blazored.LocalStorage
@using share.Models
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILocalStorageService localStorage

<div class="wrapper">
    <div class="main">
        <div class="flex-grow-1">
            @if(cart != null)
            {
                @foreach (var food in cart)
                {
                   <div class="cart-row">
                       <img src="@food.Image" class="food-img"/>
                  
                       <div class="food-name">@food.Name</div>
                  
                       <div class="d-flex me-4">
                           <button class="btn btn-secondary" @onclick="(() => decrease(food))">-</button>
                           <div class="quantity">@food.Quantity</div>
                           <button class="btn btn-warning" @onclick="(() => increase(food))">+</button>
                       </div>
                  
                       <div class="price">@(String.Format("{0:#,##0}", food.Price)) VNĐ</div>
                   </div>
                }
            }
        </div>

        <div style="width: 300px;">
            <div class="d-flex justify-content-between">
                <div>Tạm tính</div>
                <div>@(String.Format("{0:#,##0}", total)) VNĐ</div>
            </div>

            <div>VAT: 10%</div>

            <div class="d-flex justify-content-between">
                <div style="font-size: 20px;font-weight: bold;">Tổng tiền: <span class="text-danger">@(String.Format("{0:#,##0}", total)) VNĐ</span></div>
            </div>

            <button class="btn btn-primary d-block w-100 py-2 mt-3 fw-bold text-light">THANH TOÁN</button>
            <button class="btn btn-light d-block w-100 py-2 mt-2 fw-bold" @onclick="goHome">TIẾP TỤC MUA SẮM</button>
        </div>
    </div>
</div>

@code {
    private List<FoodModel> cart { get; set; }
    private double total { get; set; } = 0;


    protected override async Task OnInitializedAsync()
    {
        bool hasCart = await localStorage.ContainKeyAsync("cart");

        if(hasCart)
        {
            cart = await localStorage.GetItemAsync<List<FoodModel>>("cart");
            getTotal();
        }
    }

    private void getTotal()
    {
        if(cart != null) {
            double _total = 0;

            for (int i = 0; i < cart.Count; i++)
            {
                _total += cart[i].Quantity * cart[i].Price;
            }

            total = _total;

        }

    }

    private void decrease(FoodModel food)
    {
        if(food.Quantity > 1)
        {
            food.Quantity--;
            getTotal();
        }
    }

    private void increase(FoodModel food)
    {
        food.Quantity++;
        getTotal();
    }

    private async Task checkout()
    {
        var order = new OrderModel()
        {
            Price = total,
            VAT = 10,
            Address = "HCM",
            Note = "HCM",
            UserId = 0
        };

        await Http.PostAsJsonAsync("https://localhost:44329/api/orders/order", order);
    }

    private void goHome()
    {
        Navigation.NavigateTo("/");
    }
}
